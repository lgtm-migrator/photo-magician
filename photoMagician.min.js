!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.photoMagician=e()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),r=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var a=[],r=!0,i=!1,n=void 0;try{for(var o,c=t[Symbol.iterator]();!(r=(o=c.next()).done)&&(a.push(o.value),!e||a.length!==e);r=!0);}catch(t){i=!0,n=t}finally{try{!r&&c.return&&c.return()}finally{if(i)throw n}}return a}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();return function(){function i(){e(this,i),this.colors={},this.cover=null,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.imageFilterConfig={vintage:"vintage",blackWhite:"blackWhite",invert:"invert",relief:"relief",mirror:"mirror",blur:"blur"}}return a(i,[{key:"createImageNode",value:function(e,a,r){var i=this;return new Promise(function(n,o){var c=void 0===e?"undefined":t(e);if(Object.is(c,"object"))i.setCanvasWidth(a,r),n(e);else if(Object.is(c,"string")){var h=new Image;h.src=e,h.crossOrigin="Anonymous",h.onload=function(){i.setCanvasWidth(a||h.width,r||h.height),n(h)},h.onerror=function(t){return o(t)}}else{o("The cover options is not a String of Object\n")}})}},{key:"getCoverExt",value:function(t){return this.checkCoverType(t),t.replace(/.*\.(jpg|jpeg|png|gif)/,"$1")}},{key:"setCanvasWidth",value:function(t,e){this.canvas.width=t,this.canvas.height=e}},{key:"checkCoverType",value:function(e){if(!Object.is(void 0===e?"undefined":t(e),"string"))throw new Error('cover can not be empty and it must be "string"')}},{key:"addWaterMark",value:async function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,i=e.coordinate,n=void 0===i?[0,0]:i,o=e.fontBold,c=void 0===o||o,h=e.fontSize,s=void 0===h?20:h,v=e.fontColor,u=void 0===v?"rgba(255,255,255,.5)":v,d=e.mode,g=void 0===d?"text":d,f=e.width,l=void 0===f?50:f,m=e.height,w=void 0===m?50:m,y=e.opacity,C=void 0===y?.5:y,b=e.waterMark,k=Object.is(g,"text"),x=Object.is(g,"image");if(!b)throw new Error("waterMark is required");if(!k&&!x)throw new Error('mode it must be "text" of "image" ');return new Promise(function(e,i){var o=t.getCoverExt(a),h=r(n,2),v=h[0],d=h[1];t.createImageNode(a).then(async function(a){if(t.waterMarkCanvas=document.createElement("canvas"),t.waterMarkCtx=t.waterMarkCanvas.getContext("2d"),x){var r=await t.createImageNode(b,a.width,a.height);t.waterMarkCanvas.width=l,t.waterMarkCanvas.height=w,t.waterMarkCtx.globalAlpha=C,t.waterMarkCtx.drawImage(r,0,0,t.waterMarkCanvas.width,t.waterMarkCanvas.height)}k&&(t.waterMarkCtx.font=(c?"bold":"")+" "+s+(/.*px$/.test(s)?"":"px")+" Microsoft YaHei",t.waterMarkCtx.fillStyle=u,t.waterMarkCtx.textBaseline="middle",t.waterMarkCtx.fillText(b,v,d)),t.ctx.drawImage(a,0,0,a.width,a.height),t.ctx.drawImage(t.waterMarkCanvas,v,d,x?t.waterMarkCanvas.width:a.width,x?t.waterMarkCanvas.height:a.height);var n=t.canvas.toDataURL("image/"+o);t.createImageNode(n).then(function(t){e(t)}).catch(i)}).catch(i)})}},{key:"clipImage",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,i=e.scale,n=void 0===i?1:i,o=e.coordinate;return new Promise(function(e,i){var c=t.getCoverExt(a),h=r(o,2),s=h[0],v=h[1],u=r(s,2),d=u[0],g=u[1],f=r(v,2),l=f[0],m=f[1],w=Math.abs(l-d),y=Math.abs(m-g);t.createImageNode(a,w,y).then(function(a){t.ctx.drawImage(a,d/n,g/n,w/n,y/n,0,0,w,y);var r=t.canvas.toDataURL("image/"+c);t.createImageNode(r).then(function(t){e(t)}).catch(i)}).catch(i)})}},{key:"copyImageData",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.width,a=t.height,r=t.data,i=this.ctx.createImageData(e,a);return i.data.set(r),i}},{key:"transFormImageData",value:function(t,e){this.filterCanvas=document.createElement("canvas"),this.filterCtx=this.filterCanvas.getContext("2d"),this.filterCanvas.width=this.canvas.width,this.filterCanvas.height=this.canvas.height;var a=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),r=a.data,i=this.canvas.width*this.canvas.height,n=this.copyImageData(a),o=0,c=0,h=0;switch(t){case this.imageFilterConfig.vintage:for(var s=0;s<i;s++){var v=.3*r[4*s]+.59*r[4*s+1]+.11*(r[4*s]+2);r[4*s]=v,r[4*s+1]=v,r[4*s+2]=v}break;case this.imageFilterConfig.blackWhite:for(var u=0;u<i;u++){var d=null;d=.3*r[4*u]+.59*r[4*u+1]+.11*(r[4*u]+2)>127.5?255:0,r[4*u]=d,r[4*u+1]=d,r[4*u+2]=d}break;case this.imageFilterConfig.invert:for(var g=0;g<i;g+=4){var f=r[g],l=r[g+1],m=r[g+2];r[g]=255-f,r[g+1]=255-l,r[g+2]=255-m}break;case this.imageFilterConfig.relief:for(var w=1;w<n.width-1;w++)for(var y=1;y<n.height-1;y++){var C=4*(w+y*n.width),b=4*(w-1+y*n.width),k=4*(w+1+y*n.width),x=n.data[k+0]-n.data[b+0]+128,p=n.data[k+1]-n.data[b+1]+128,I=n.data[k+2]-n.data[b+2]+128;x=x<0?0:x>255?255:x,p=p<0?0:p>255?255:p,I=I<0?0:I>255?255:I,r[C+0]=x,r[C+1]=p,r[C+2]=I,r[C+3]=255}break;case this.imageFilterConfig.mirror:for(var M=0;M<n.width;M++)for(var j=0;j<n.height;j++){var N=4*(M+j*n.width),D=4*(n.width-1-M+j*n.width);r[D+0]=r[N+0],r[D+1]=r[N+1],r[D+2]=r[N+2],r[D+3]=255}break;case this.imageFilterConfig.blur:for(var E=0;E<n.width;E++)for(var O=0;O<n.height;O++){for(var F=4*(E+O*n.width),P=-2;P<=2;P++){var S=P+E;(S<0||S>=n.width)&&(S=0);for(var U=-2;U<=2;U++){var W=U+O;(W<0||W>=n.height)&&(W=0);var L=4*(S+W*n.width);o+=n.data[L+0],c+=n.data[L+1],h+=n.data[L+2]}}var R=o/25,T=c/25,A=h/25;o=0,c=0,h=0,r[F+0]=R,r[F+1]=T,r[F+2]=A,r[F+3]=255}}return this.filterCtx.putImageData(a,0,0,0,0,this.filterCanvas.width,this.filterCanvas.height),this.filterCanvas.toDataURL("image/"+e)}},{key:"addImageFilter",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,r=e.mode,i=void 0===r?this.imageFilterConfig.vintage:r;return new Promise(function(e,r){var n=t.getCoverExt(a);t.createImageNode(a).then(function(a){t.ctx.drawImage(a,0,0,a.width,a.height);var o=t.transFormImageData(i,n);t.createImageNode(o).then(function(t){e(t)}).catch(r)}).catch(r)})}},{key:"rotateImage",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,r=e.rotate,i=void 0===r?0:r;return new Promise(function(e,r){var n=t.getCoverExt(a);t.createImageNode(a).then(function(a){t.ctx.save(),t.ctx.rotate(i*Math.PI/180),t.ctx.drawImage(a,0,0,a.width,a.height),t.ctx.restore();var o=t.canvas.toDataURL("image/"+n);t.createImageNode(o).then(function(t){e(t)}).catch(r)}).catch(r)})}},{key:"toBase64Url",value:function(t){var e=this,a=t.cover;return new Promise(function(t,r){var i=e.getCoverExt(a);e.createImageNode(a).then(function(a){e.ctx.drawImage(a,0,0,a.width,a.height);var r=e.canvas.toDataURL("image/"+i);t(r)}).catch(r)})}},{key:"compressImage",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,r=e.quality,i=void 0===r?.92:r;return new Promise(function(e,r){t.createImageNode(a).then(function(a){t.ctx.drawImage(a,0,0,a.width,a.height);var n=t.canvas.toDataURL("image/jpeg",Number(i));t.createImageNode(n).then(function(t){e(t)}).catch(r)}).catch(r)})}},{key:"getPrimaryColor",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).cover;return new Promise(function(a,r){t.createImageNode(e).then(function(e){t.ctx.drawImage(e,0,0,e.width,e.height);for(var r=t.ctx.getImageData(0,0,e.width,e.height),i=r.data,n=0,o=r.width*r.height;n<o;n++){var c=[i[4*n],i[4*n+1],i[4*n+2],i[4*n+3]],h="rgba("+c[0]+","+c[1]+","+c[2]+","+c[3]+")";t.colors[h]?t.colors[h].num++:t.colors[h]={color:h,num:1}}var s=t.getMax(t.colors);a(s)}).catch(r)})}},{key:"getMax",value:function(t){var e=Object.values(t).sort(function(t,e){return t.num-e.num});return e[e.length-1].color}},{key:"getValues",value:function(t){return Object.values&&Object.values(t)||Object.keys(t).map(function(e){return t[e]})}}]),i}()});
