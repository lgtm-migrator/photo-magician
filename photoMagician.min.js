!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.photoMagician=e()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),i=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var a=[],i=!0,r=!1,n=void 0;try{for(var o,s=t[Symbol.iterator]();!(i=(o=s.next()).done)&&(a.push(o.value),!e||a.length!==e);i=!0);}catch(t){r=!0,n=t}finally{try{!i&&s.return&&s.return()}finally{if(r)throw n}}return a}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();return function(){function r(){e(this,r),this.colors={},this.cover=null,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.imageFilterConfig={vintage:"vintage",blackWhite:"blackWhite",invert:"invert",relief:"relief",mirror:"mirror",blur:"blur"}}return a(r,[{key:"createImageNode",value:function(e,a,i){var r=this;return new Promise(function(n,o){var s=void 0===e?"undefined":t(e);if(Object.is(s,"object"))r.setCanvasWidth(a,i),n(e);else{if(!Object.is(s,"string")){var h="The cover options is not a String of Object\n";throw o(h),new Error(h)}var c=new Image;c.src=e,c.crossOrigin="Anonymous",c.onload=function(){var t=r.getCoverExt(e);r.setCanvasWidth(a||c.width,i||c.height),n({suffix:t,img:c})},c.onerror=function(t){return o(t)}}})}},{key:"getCoverExt",value:function(t){return this.checkCoverType(t),t.replace(/.*\.(jpg|jpeg|png|gif)/,"$1")}},{key:"setCanvasWidth",value:function(t,e){this.canvas.width=t,this.canvas.height=e}},{key:"checkCoverType",value:function(e){if(!Object.is(void 0===e?"undefined":t(e),"string"))throw new Error('cover can not be empty and it must be "string"')}},{key:"addWaterMark",value:async function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.cover,a=t.coordinate,r=void 0===a?[0,0]:a,n=t.fontBold,o=void 0===n||n,s=t.fontSize,h=void 0===s?20:s,c=t.fontColor,v=void 0===c?"rgba(255,255,255,.5)":c,u=t.mode,d=void 0===u?"text":u,g=t.width,f=void 0===g?50:g,l=t.height,m=void 0===l?50:l,w=t.opacity,y=void 0===w?.5:w,b=t.waterMark;if(!Array.isArray(r)||2!==r.length)throw new Error("coordinate must be a array. like [x,y]");var x=Object.is(d,"text"),k=Object.is(d,"image");if(!b)throw new Error("waterMark is required.");if(!x&&!k)throw new Error('mode it must be "text" of "image" .');var C=i(r,2),p=C[0],I=C[1],M=await this.createImageNode(e),j=M.img,E=M.suffix;if(this.waterMarkCanvas=document.createElement("canvas"),this.waterMarkCtx=this.waterMarkCanvas.getContext("2d"),k){var O=(await this.createImageNode(b,j.width,j.height)).img;this.waterMarkCanvas.width=f+100,this.waterMarkCanvas.height=m+100,this.waterMarkCtx.globalAlpha=y,this.waterMarkCtx.drawImage(O,0,0,this.waterMarkCanvas.width,this.waterMarkCanvas.height)}return x&&(this.waterMarkCtx.font=(o?"bold":"")+" "+h+(/.*px$/.test(h)?"":"px")+" Microsoft YaHei",this.waterMarkCtx.fillStyle=v,this.waterMarkCtx.textBaseline="middle",this.waterMarkCtx.fillText(b,p,I)),this.ctx.drawImage(j,0,0,j.width,j.height),this.ctx.drawImage(this.waterMarkCanvas,p,I,k?this.waterMarkCanvas.width:j.width,k?this.waterMarkCanvas.height:j.height),this.canvas.toDataURL("image/"+E)}},{key:"clipImage",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,r=e.scale,n=void 0===r?1:r,o=e.coordinate,s=void 0===o?[]:o;if(s.some(function(t){return!Array.isArray(t)||2!==t.length}))throw new Error("coordinate must be a array, like [[x1,y1],[x2,y2]]");if(!Object.is(void 0===n?"undefined":t(n),"number"))throw new Error("scale must be a number.");var h=i(s,2),c=h[0],v=h[1],u=i(c,2),d=u[0],g=u[1],f=i(v,2),l=f[0],m=f[1],w=Math.abs(l-d),y=Math.abs(m-g),b=await this.createImageNode(a,w,y),x=b.img,k=b.suffix;return this.ctx.drawImage(x,d/n,g/n,w/n,y/n,0,0,w,y),this.canvas.toDataURL("image/"+k)}},{key:"copyImageData",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.width,a=t.height,i=t.data,r=this.ctx.createImageData(e,a);return r.data.set(i),r}},{key:"transFormImageData",value:function(t,e){this.filterCanvas=document.createElement("canvas"),this.filterCtx=this.filterCanvas.getContext("2d"),this.filterCanvas.width=this.canvas.width,this.filterCanvas.height=this.canvas.height;var a=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),i=a.data,r=this.canvas.width*this.canvas.height,n=this.copyImageData(a),o=0,s=0,h=0;switch(t){case this.imageFilterConfig.vintage:for(var c=0;c<r;c++){var v=.3*i[4*c]+.59*i[4*c+1]+.11*(i[4*c]+2);i[4*c]=v,i[4*c+1]=v,i[4*c+2]=v}break;case this.imageFilterConfig.blackWhite:for(var u=0;u<r;u++){var d=null;d=.3*i[4*u]+.59*i[4*u+1]+.11*(i[4*u]+2)>127.5?255:0,i[4*u]=d,i[4*u+1]=d,i[4*u+2]=d}break;case this.imageFilterConfig.invert:for(var g=0;g<r;g+=4){var f=i[g],l=i[g+1],m=i[g+2];i[g]=255-f,i[g+1]=255-l,i[g+2]=255-m}break;case this.imageFilterConfig.relief:for(var w=1;w<n.width-1;w++)for(var y=1;y<n.height-1;y++){var b=4*(w+y*n.width),x=4*(w-1+y*n.width),k=4*(w+1+y*n.width),C=n.data[k+0]-n.data[x+0]+128,p=n.data[k+1]-n.data[x+1]+128,I=n.data[k+2]-n.data[x+2]+128;C=C<0?0:C>255?255:C,p=p<0?0:p>255?255:p,I=I<0?0:I>255?255:I,i[b+0]=C,i[b+1]=p,i[b+2]=I,i[b+3]=255}break;case this.imageFilterConfig.mirror:for(var M=0;M<n.width;M++)for(var j=0;j<n.height;j++){var E=4*(M+j*n.width),O=4*(n.width-1-M+j*n.width);i[O+0]=i[E+0],i[O+1]=i[E+1],i[O+2]=i[E+2],i[O+3]=255}break;case this.imageFilterConfig.blur:for(var D=0;D<n.width;D++)for(var F=0;F<n.height;F++){for(var N=4*(D+F*n.width),S=-2;S<=2;S++){var A=S+D;(A<0||A>=n.width)&&(A=0);for(var U=-2;U<=2;U++){var W=U+F;(W<0||W>=n.height)&&(W=0);var L=4*(A+W*n.width);o+=n.data[L+0],s+=n.data[L+1],h+=n.data[L+2]}}var R=o/25,T=s/25,P=h/25;o=0,s=0,h=0,i[N+0]=R,i[N+1]=T,i[N+2]=P,i[N+3]=255}}return this.filterCtx.putImageData(a,0,0,0,0,this.filterCanvas.width,this.filterCanvas.height),this.filterCanvas.toDataURL("image/"+e)}},{key:"addImageFilter",value:async function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.cover,a=t.mode,i=void 0===a?this.imageFilterConfig.vintage:a,r=Object.values(this.imageFilterConfig);if(!r.includes(i))throw new Error("mode must one of ["+r.join(",")+"]");var n=await this.createImageNode(e),o=n.img,s=n.suffix;return this.ctx.drawImage(o,0,0,o.width,o.height),this.transFormImageData(i,s)}},{key:"rotateImage",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,i=e.rotate,r=void 0===i?0:i;if(!Object.is(void 0===r?"undefined":t(r),"number"))throw new Error("rotate must be a number.");var n=await this.createImageNode(a),o=n.img,s=n.suffix;return this.ctx.save(),this.ctx.rotate(r*Math.PI/180),this.ctx.drawImage(o,0,0,o.width,o.height),this.ctx.restore(),this.canvas.toDataURL("image/"+s)}},{key:"toBase64Url",value:async function(t){var e=t.cover,a=await this.createImageNode(e),i=a.img,r=a.suffix;return this.ctx.drawImage(i,0,0,i.width,i.height),this.canvas.toDataURL("image/"+r)}},{key:"compressImage",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.cover,i=e.quality,r=void 0===i?.92:i;if(!Object.is(void 0===r?"undefined":t(r),"number"))throw new Error("quality must be a number.");var n=(await this.createImageNode(a)).img;return this.ctx.drawImage(n,0,0,n.width,n.height),this.canvas.toDataURL(.92===r?"image/png":"image/jpeg",Number(r))}},{key:"getPrimaryColor",value:async function(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).cover,e=(await this.createImageNode(t)).img;this.ctx.drawImage(e,0,0,e.width,e.height);for(var a=this.ctx.getImageData(0,0,e.width,e.height),i=a.data,r=0,n=a.width*a.height;r<n;r++){var o=[i[4*r],i[4*r+1],i[4*r+2],i[4*r+3]],s="rgba("+o[0]+","+o[1]+","+o[2]+","+o[3]+")";this.colors[s]?this.colors[s].num++:this.colors[s]={color:s,num:1}}return this.getMax(this.colors)}},{key:"getMax",value:function(t){var e=Object.values(t).sort(function(t,e){return t.num-e.num});return e[e.length-1].color}},{key:"getValues",value:function(t){return Object.values&&Object.values(t)||Object.keys(t).map(function(e){return t[e]})}}]),r}()});
