"use strict";var _isIterable2=require("babel-runtime/core-js/is-iterable"),_isIterable3=_interopRequireDefault(_isIterable2),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_iterator=require("babel-runtime/core-js/symbol/iterator"),_iterator2=_interopRequireDefault(_iterator),_symbol=require("babel-runtime/core-js/symbol"),_symbol2=_interopRequireDefault(_symbol),_defineProperty=require("babel-runtime/core-js/object/define-property"),_defineProperty2=_interopRequireDefault(_defineProperty),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_values=require("babel-runtime/core-js/object/values"),_values2=_interopRequireDefault(_values),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_is=require("babel-runtime/core-js/object/is"),_is2=_interopRequireDefault(_is),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_slicedToArray=function(e,t){if(Array.isArray(e))return e;if((0,_isIterable3.default)(Object(e)))return function(e,t){var a=[],r=!0,i=!1,n=void 0;try{for(var o,c=(0,_getIterator3.default)(e);!(r=(o=c.next()).done)&&(a.push(o.value),!t||a.length!==t);r=!0);}catch(e){i=!0,n=e}finally{try{!r&&c.return&&c.return()}finally{if(i)throw n}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_typeof="function"==typeof _symbol2.default&&"symbol"==typeof _iterator2.default?function(e){return typeof e}:function(e){return e&&"function"==typeof _symbol2.default&&e.constructor===_symbol2.default&&e!==_symbol2.default.prototype?"symbol":typeof e},_createClass=function(){function r(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),(0,_defineProperty2.default)(e,r.key,r)}}return function(e,t,a){return t&&r(e.prototype,t),a&&r(e,a),e}}();function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var c=e.apply(this,arguments);return new _promise2.default(function(n,o){return function t(e,a){try{var r=c[e](a),i=r.value}catch(e){return void o(e)}if(!r.done)return _promise2.default.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});n(i)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var VERSION="0.4.0",PACKAGE_NAME="imageMagician";!function(e,t){var a="function"==typeof define,r="undefined"!=typeof module&&module.exports;a?define(t):r?(exports.default=t(),module.exports=exports.default):(void 0)[e]=t()}(PACKAGE_NAME,function(){return function(){function e(){_classCallCheck(this,e),this.colors={},this.cover=null,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.imageFilterConfig={vintage:"vintage",blackWhite:"blackWhite",invert:"invert",relief:"relief",mirror:"mirror",blur:"blur"}}var t;return _createClass(e,[{key:"createImageNode",value:function(i,n,o){var c=this;return new _promise2.default(function(e,t){var a=void 0===i?"undefined":_typeof(i);if((0,_is2.default)(a,"object"))c.setCanvasWidth(n,o),e(i);else if((0,_is2.default)(a,"string")){var r=new Image;r.src=i,r.onload=function(){c.setCanvasWidth(n||r.width,o||r.height),e(r)},r.onerror=function(e){return t(e)}}else{t("The cover options is not a String of Object\n")}})}},{key:"getCoverExt",value:function(e){return this.checkCoverType(e),e.replace(/.*\.(jpg|jpeg|png|gif)/,"$1")}},{key:"setCanvasWidth",value:function(e,t){this.canvas.width=e,this.canvas.height=t}},{key:"checkCoverType",value:function(e){if(!(0,_is2.default)(void 0===e?"undefined":_typeof(e),"string"))throw new Error('cover it must be "string"')}},{key:"addWaterMark",value:(t=_asyncToGenerator(_regenerator2.default.mark(function e(){var s,l,h=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=t.cover,r=t.coordinate,f=void 0===r?[0,0]:r,i=t.fontBold,d=void 0===i||i,n=t.fontSize,v=void 0===n?20:n,o=t.fontColor,g=void 0===o?"rgba(255,255,255,.5)":o,c=t.mode,u=void 0===c?"text":c,m=t.width,_=void 0===m?50:m,w=t.height,p=void 0===w?50:w,y=t.opacity,b=void 0===y?.5:y,C=t.waterMark;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=(0,_is2.default)(u,"text"),l=(0,_is2.default)(u,"image"),C){e.next=4;break}throw new Error("waterMark is required");case 4:if(s||l){e.next=6;break}throw new Error('mode it must be "text" of "image" ');case 6:return e.abrupt("return",new _promise2.default(function(i,n){var t,o=h.getCoverExt(a),e=_slicedToArray(f,2),c=e[0],u=e[1];h.createImageNode(a).then((t=_asyncToGenerator(_regenerator2.default.mark(function e(t){var a,r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(h.waterMarkCanvas=document.createElement("canvas"),h.waterMarkCtx=h.waterMarkCanvas.getContext("2d"),!l){e.next=10;break}return e.next=5,h.createImageNode(C,t.width,t.height);case 5:a=e.sent,h.waterMarkCanvas.width=_,h.waterMarkCanvas.height=p,h.waterMarkCtx.globalAlpha=b,h.waterMarkCtx.drawImage(a,0,0,h.waterMarkCanvas.width,h.waterMarkCanvas.height);case 10:s&&(h.waterMarkCtx.font=(d?"bold":"")+" "+v+(/.*px$/.test(v)?"":"px")+" Microsoft YaHei",h.waterMarkCtx.fillStyle=g,h.waterMarkCtx.textBaseline="middle",h.waterMarkCtx.fillText(C,c,u)),h.ctx.drawImage(t,0,0,t.width,t.height),h.ctx.drawImage(h.waterMarkCanvas,c,u,l?h.waterMarkCanvas.width:t.width,l?h.waterMarkCanvas.height:t.height),r=h.canvas.toDataURL("image/"+o),h.createImageNode(r).then(function(e){i(e)}).catch(n);case 15:case"end":return e.stop()}},e,h)})),function(e){return t.apply(this,arguments)})).catch(n)}));case 7:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"clipImage",value:function(){var v=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},g=e.cover,t=e.scale,m=void 0===t?1:t,_=e.coordinate;return new _promise2.default(function(a,r){var i=v.getCoverExt(g),e=_slicedToArray(_,2),t=e[0],n=e[1],o=_slicedToArray(t,2),c=o[0],u=o[1],s=_slicedToArray(n,2),l=s[0],h=s[1],f=Math.abs(l-c),d=Math.abs(h-u);v.createImageNode(g,f,d).then(function(e){v.ctx.drawImage(e,c/m,u/m,f/m,d/m,0,0,f,d);var t=v.canvas.toDataURL("image/"+i);v.createImageNode(t).then(function(e){a(e)}).catch(r)}).catch(r)})}},{key:"copyImageData",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.width,a=e.height,r=e.data,i=this.ctx.createImageData(t,a);return i.data.set(r),i}},{key:"transFormImageData",value:function(e,t){this.filterCanvas=document.createElement("canvas"),this.filterCtx=this.filterCanvas.getContext("2d"),this.filterCanvas.width=this.canvas.width,this.filterCanvas.height=this.canvas.height;var a=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),r=(a.width,a.height,a.data),i=this.canvas.width*this.canvas.height;switch(e){case this.imageFilterConfig.vintage:for(var n=0;n<i;n++){var o=.3*r[4*n]+.59*r[4*n+1]+.11*(r[4*n]+2);r[4*n]=o,r[4*n+1]=o,r[4*n+2]=o}break;case this.imageFilterConfig.blackWhite:for(var c=0;c<i;c++){var u=null;u=127.5<.3*r[4*c]+.59*r[4*c+1]+.11*(r[4*c]+2)?255:0,r[4*c]=u,r[4*c+1]=u,r[4*c+2]=u}break;case this.imageFilterConfig.invert:for(var s=0;s<i;s+=4){var l=r[s],h=r[s+1],f=r[s+2];r[s]=255-l,r[s+1]=255-h,r[s+2]=255-f}break;case this.imageFilterConfig.relief:for(var d=this.copyImageData(a),v=1;v<d.width-1;v++)for(var g=1;g<d.height-1;g++){var m=4*(v+g*d.width),_=4*(v-1+g*d.width),w=4*(v+1+g*d.width),p=d.data[w+0]-d.data[_+0]+128,y=d.data[w+1]-d.data[_+1]+128,b=d.data[w+2]-d.data[_+2]+128;p=p<0?0:255<p?255:p,y=y<0?0:255<y?255:y,b=b<0?0:255<b?255:b,r[m+0]=p,r[m+1]=y,r[m+2]=b,r[m+3]=255}break;case this.imageFilterConfig.mirror:for(var C=this.copyImageData(a),k=0;k<C.width;k++)for(var x=0;x<C.height;x++){var I=4*(k+x*C.width),M=4*(C.width-1-k+x*C.width);r[M+0]=r[I+0],r[M+1]=r[I+1],r[M+2]=r[I+2],r[M+3]=255}break;case this.imageFilterConfig.blur:for(var D=this.copyImageData(a),q=0,j=0,E=0,N=0;N<D.width;N++)for(var R=0;R<D.height;R++){for(var A=4*(N+R*D.width),T=-2;T<=2;T++){var F=T+N;(F<0||F>=D.width)&&(F=0);for(var P=-2;P<=2;P++){var U=P+R;(U<0||U>=D.height)&&(U=0);var W=4*(F+U*D.width);q+=D.data[W+0],j+=D.data[W+1],E+=D.data[W+2]}}var L=q/25,G=j/25,S=E/25;r[A+(E=j=q=0)]=L,r[A+1]=G,r[A+2]=S,r[A+3]=255}}return this.filterCtx.putImageData(a,0,0,0,0,this.filterCanvas.width,this.filterCanvas.height),this.filterCanvas.toDataURL("image/"+t)}},{key:"addImageFilter",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.cover,a=e.mode,o=void 0===a?this.imageFilterConfig.vintage:a;return new _promise2.default(function(a,r){var i=n.getCoverExt(t);n.createImageNode(t).then(function(e){n.ctx.drawImage(e,0,0,e.width,e.height);var t=n.transFormImageData(o,i);n.createImageNode(t).then(function(e){a(e)}).catch(r)}).catch(r)})}},{key:"rotateImage",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.cover,a=e.rotate,o=void 0===a?0:a;return new _promise2.default(function(a,r){var i=n.getCoverExt(t);n.createImageNode(t).then(function(e){n.ctx.save(),n.ctx.rotate(o*Math.PI/180),n.ctx.drawImage(e,0,0,e.width,e.height),n.ctx.restore();var t=n.canvas.toDataURL("image/"+i);n.createImageNode(t).then(function(e){a(e)}).catch(r)}).catch(r)})}},{key:"toBase64Url",value:function(e){var i=this,t=e.cover;return new _promise2.default(function(a,e){var r=i.getCoverExt(t);i.createImageNode(t).then(function(e){i.ctx.drawImage(e,0,0,e.width,e.height);var t=i.canvas.toDataURL("image/"+r);a(t)}).catch(e)})}},{key:"compressImage",value:function(){var i=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.cover,a=e.quality,n=void 0===a?.92:a;return new _promise2.default(function(a,r){i.createImageNode(t).then(function(e){i.ctx.drawImage(e,0,0,e.width,e.height);var t=i.canvas.toDataURL("image/jpeg",Number(n));i.createImageNode(t).then(function(e){a(e)}).catch(r)}).catch(r)})}},{key:"getPrimaryColor",value:function(){var s=this,t=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).cover;return new _promise2.default(function(u,e){s.createImageNode(t).then(function(e){s.ctx.drawImage(e,0,0,e.width,e.height);for(var t=s.ctx.getImageData(0,0,e.width,e.height),a=t.data,r=0,i=t.width*t.height;r<i;r++){var n=[a[4*r],a[4*r+1],a[4*r+2],a[4*r+3]],o="rgba("+n[0]+","+n[1]+","+n[2]+","+n[3]+")";s.colors[o]?s.colors[o].num++:s.colors[o]={color:o,num:1}}var c=s.getMax(s.colors);u(c)}).catch(e)})}}],[{key:"getMax",value:function(e){var t=(0,_values2.default)(e).sort(function(e,t){return e.num-t.num});return t[t.length-1].color}},{key:"getValues",value:function(t){return _values2.default&&(0,_values2.default)(t)||(0,_keys2.default)(t).map(function(e){return t[e]})}}]),e}()});