"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_is=require("babel-runtime/core-js/object/is"),_is2=_interopRequireDefault(_is),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);!function(e,t){var a=function(){function e(){(0,_classCallCheck3.default)(this,e),this.cover=null,this.canvas=t.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.imageFilterConfig={vintage:"vintage",blackWhite:"blackWhite",invert:"invert",relief:"relief",mirror:"mirror",blur:"blur"}}return(0,_createClass3.default)(e,[{key:"createImageNode",value:function(e,t,a){var r=this;return new _promise2.default(function(i,n){var o=void 0===e?"undefined":(0,_typeof3.default)(e);if((0,_is2.default)(o,"object"))r.setCanvasWidth(t,a),i(e);else if((0,_is2.default)(o,"string")){var s=new Image;s.src=e,s.onload=function(){r.setCanvasWidth(t||s.width,a||s.height),i(s)},s.onerror=function(e){return n(e)}}else{n("The cover options is not a String of Object\n")}})}},{key:"getCoverExt",value:function(e){return this.checkCoverType(e),e.replace(/.*\.(jpg|jpeg|png|gif)/,"$1")}},{key:"setCanvasWidth",value:function(e,t){this.canvas.width=e,this.canvas.height=t}},{key:"checkCoverType",value:function(e){if(!(0,_is2.default)(void 0===e?"undefined":(0,_typeof3.default)(e),"string"))throw new Error('cover it must be "string"')}},{key:"addWaterMark",value:function(){function e(){return a.apply(this,arguments)}var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var a,r,i=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:options,o=n.cover,s=n.coordinate,c=void 0===s?[0,0]:s,h=n.fontBold,u=void 0===h||h,l=n.fontSize,d=void 0===l?20:l,v=n.fontColor,f=void 0===v?"rgba(255,255,255,.5)":v,g=n.mode,m=void 0===g?"text":g,w=n.width,p=void 0===w?50:w,C=n.height,_=void 0===C?50:C,k=n.opacity,x=void 0===k?.5:k,y=n.waterMark;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=(0,_is2.default)(m,"text"),r=(0,_is2.default)(m,"image"),y){e.next=4;break}throw new Error("waterMark is required");case 4:if(a||r){e.next=6;break}throw new Error('mode it must be "text" of "image" ');case 6:return e.abrupt("return",new _promise2.default(function(e,n){var s=i.getCoverExt(o),h=(0,_slicedToArray3.default)(c,2),l=h[0],v=h[1];i.createImageNode(o).then(function(){var o=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function o(c){var h,g;return _regenerator2.default.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(i.waterMarkCanvas=t.createElement("canvas"),i.waterMarkCtx=i.waterMarkCanvas.getContext("2d"),!r){o.next=10;break}return o.next=5,i.createImageNode(y,c.width,c.height);case 5:h=o.sent,i.waterMarkCanvas.width=p,i.waterMarkCanvas.height=_,i.waterMarkCtx.globalAlpha=x,i.waterMarkCtx.drawImage(h,0,0,i.waterMarkCanvas.width,i.waterMarkCanvas.height);case 10:a&&(i.waterMarkCtx.font=(u?"bold":"")+" "+d+(/.*px$/.test(d)?"":"px")+" Microsoft YaHei",i.waterMarkCtx.fillStyle=f,i.waterMarkCtx.textBaseline="middle",i.waterMarkCtx.fillText(y,l,v)),i.ctx.drawImage(c,0,0,c.width,c.height),i.ctx.drawImage(i.waterMarkCanvas,l,v,r?i.waterMarkCanvas.width:c.width,r?i.waterMarkCanvas.height:c.height),g=i.canvas.toDataURL("image/"+s),i.createImageNode(g).then(function(t){e(t)}).catch(n);case 15:case"end":return o.stop()}},o,i)}));return function(e){return o.apply(this,arguments)}}()).catch(n)}));case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"clipImage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:options,a=t.cover,r=t.scale,i=void 0===r?1:r,n=t.coordinate;return new _promise2.default(function(t,r){var o=e.getCoverExt(a),s=(0,_slicedToArray3.default)(n,2),c=s[0],h=s[1],u=(0,_slicedToArray3.default)(c,2),l=u[0],d=u[1],v=(0,_slicedToArray3.default)(h,2),f=v[0],g=v[1],m=Math.abs(f-l),w=Math.abs(g-d);e.createImageNode(a,m,w).then(function(a){e.ctx.drawImage(a,l/i,d/i,m/i,w/i,0,0,m,w);var n=e.canvas.toDataURL("image/"+o);e.createImageNode(n).then(function(e){t(e)}).catch(r)}).catch(r)})}},{key:"copyImageData",value:function(e){var t=e.width,a=e.height,r=e.data,i=this.ctx.createImageData(t,a);return i.data.set(r),i}},{key:"transFormImageData",value:function(e,a){this.filterCanvas=t.createElement("canvas"),this.filterCtx=this.filterCanvas.getContext("2d"),this.filterCanvas.width=this.canvas.width,this.filterCanvas.height=this.canvas.height;var r=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),i=(r.width,r.height,r.data),n=this.canvas.width*this.canvas.height;switch(e){case this.imageFilterConfig.vintage:for(var o=0;o<n;o++){var s=i[4*o],c=i[4*o+1],h=i[4*o]+2,u=.3*s+.59*c+.11*h;i[4*o]=u,i[4*o+1]=u,i[4*o+2]=u}break;case this.imageFilterConfig.blackWhite:for(var l=0;l<n;l++){var d=i[4*l],v=i[4*l+1],f=i[4*l]+2,g=null;g=.3*d+.59*v+.11*f>127.5?255:0,i[4*l]=g,i[4*l+1]=g,i[4*l+2]=g}break;case this.imageFilterConfig.invert:for(var m=0;m<n;m+=4){var w=i[m],p=i[m+1],C=i[m+2];i[m]=255-w,i[m+1]=255-p,i[m+2]=255-C}break;case this.imageFilterConfig.relief:for(var _=this.copyImageData(r),k=1;k<_.width-1;k++)for(var x=1;x<_.height-1;x++){var y=4*(k+x*_.width),b=4*(k-1+x*_.width),I=4*(k+1+x*_.width),M=_.data[I+0]-_.data[b+0]+128,D=_.data[I+1]-_.data[b+1]+128,q=_.data[I+2]-_.data[b+2]+128;M=M<0?0:M>255?255:M,D=D<0?0:D>255?255:D,q=q<0?0:q>255?255:q,i[y+0]=M,i[y+1]=D,i[y+2]=q,i[y+3]=255}break;case this.imageFilterConfig.mirror:for(var T=this.copyImageData(r),R=0;R<T.width;R++)for(var N=0;N<T.height;N++){var E=4*(R+N*T.width),F=4*(T.width-1-R+N*T.width);i[F+0]=i[E+0],i[F+1]=i[E+1],i[F+2]=i[E+2],i[F+3]=255}break;case this.imageFilterConfig.blur:for(var A=this.copyImageData(r),j=0,U=0,W=0,G=0;G<A.width;G++)for(var L=0;L<A.height;L++){for(var B=4*(G+L*A.width),S=-2;S<=2;S++){var $=S+G;($<0||$>=A.width)&&($=0);for(var z=-2;z<=2;z++){var H=z+L;(H<0||H>=A.height)&&(H=0);var O=4*($+H*A.width),P=A.data[O+0],Y=A.data[O+1],J=A.data[O+2];j+=P,U+=Y,W+=J}}var K=j/25,Q=U/25,V=W/25;j=0,U=0,W=0,i[B+0]=K,i[B+1]=Q,i[B+2]=V,i[B+3]=255}}return this.filterCtx.putImageData(r,0,0,0,0,this.filterCanvas.width,this.filterCanvas.height),this.filterCanvas.toDataURL("image/"+a)}},{key:"addImageFilter",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:options,a=t.cover,r=t.mode,i=void 0===r?this.imageFilterConfig.vintage:r;return new _promise2.default(function(t,r){var n=e.getCoverExt(a);e.createImageNode(a).then(function(a){e.ctx.drawImage(a,0,0,a.width,a.height);var o=e.transFormImageData(i,n);e.createImageNode(o).then(function(e){t(e)}).catch(r)}).catch(r)})}},{key:"rotateImage",value:function(e){var t=this,a=e.cover,r=e.rotate,i=void 0===r?0:r;return new _promise2.default(function(e,r){var n=t.getCoverExt(a);t.createImageNode(a).then(function(a){t.ctx.save(),t.ctx.rotate(i*Math.PI/180),t.ctx.drawImage(a,0,0,a.width,a.height),t.ctx.restore();var o=t.canvas.toDataURL("image/"+n);t.createImageNode(o).then(function(t){e(t)}).catch(r)}).catch(r)})}},{key:"toBase64Url",value:function(e){var t=this,a=e.cover;return new _promise2.default(function(e,r){var i=t.getCoverExt(a);t.createImageNode(a).then(function(a){t.ctx.drawImage(a,0,0,a.width,a.height);var r=t.canvas.toDataURL("image/"+i);e(r)}).catch(r)})}},{key:"compressImage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:options,a=t.cover,r=t.quality,i=void 0===r?.92:r;return new _promise2.default(function(t,r){e.createImageNode(a).then(function(a){e.ctx.drawImage(a,0,0,a.width,a.height);var n=e.canvas.toDataURL("image/jpeg",Number(i));e.createImageNode(n).then(function(e){t(e)}).catch(r)}).catch(r)})}}]),e}();e.ImageMagician=a}(window,document);